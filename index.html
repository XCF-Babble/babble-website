<!doctype html>
<html lang="zh_CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Babble - 说都不会话了</title>
        <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    </head>
    <body class="d-flex flex-column h-100">
        <div class="container">
            <h1 class="mt-5">Babble</h1>
            <p class="lead">说都不会话了。</p>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <textarea class="form-control" id="plainText" rows="5" placeholder="明文"></textarea>
                        </div>
                        <div class="col-md-auto">
                            <div class="form-group">
                                <button type="button" class="btn btn-primary btn-block" id="babbleButton">不会话&gt;&gt;</button>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary btn-block" id="debabbleButton">&lt;&lt;会说</button>
                            </div>
                            <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#settingsModal">设置</button>
                        </div>
                        <div class="col">
                            <textarea class="form-control" id="cipherText" rows="5" placeholder="密文"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" role="dialog" id="settingsModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">设置</h5>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="passphraseText">密码</label>
                            <input type="text" class="form-control" id="passphraseText">
                        </div>
                        <div class="form-group">
                            <label for="baseText">基底</label>
                            <input type="text" class="form-control" id="baseText" minlength="256" maxlength="256">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="settingsConfirmButton">确定</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" role="dialog" id="errorModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">错误</h5>
                    </div>
                    <div class="modal-body">
                        基底必须为256个汉字长。
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="sodium.js"></script>
        <script>
            var babbleSalt = 'BabbleBabbleBabb';
            var babblePassphrase = '';
            var babbleBase = '的一是了人在有我他这为之来以个们到说和地也子时而要于就下得可你年生自会那后能对着事其里所去行过十用发如然方成者多都三二同么当起与好看学进将还分此心前面又定见只从现因开些长明样已月正想实把相两力等外它并间手应全门点身由何向至物被五及入先己或很最书美山什名曰合加世水果位度马给数次今表原各才几解则气再听提万更比百尔即白许系且光路接结题指感量取场电空边件住放风求形望传笑叫往区达设记字故品象花七服据云像飞远收石类程转千式流每该始术格运怎步让识拉若备造快集布尽称确呢节注存具甚容吃算坐早引似视尚轻况留照写足余星居技属找食';
            var babbleKey;
            function loadSettings() {
                if (typeof(Storage) !== "undefined") {
                    if (typeof(localStorage.babblePassphrase) !== "undefined")
                        babblePassphrase = localStorage.babblePassphrase;
                    if (typeof(localStorage.babbleBase) !== "undefined")
                        babbleBase = localStorage.babbleBase;
                }
                babbleKey = deriveKey();
            }
            function saveSettings() {
                if (typeof(Storage) !== "undefined") {
                    localStorage.babblePassphrase = babblePassphrase;
                    localStorage.babbleBase = babbleBase;
                }
            }
            function setSettingsTexts() {
                $('#passphraseText').val(babblePassphrase);
                $('#baseText').val(babbleBase);
            }
            function settingsEnterPressed(e) {
                if (e.keyCode == 13)
                    $('#settingsConfirmButton').click();
            }
            function deriveKey() {
                return sodium.crypto_pwhash(sodium.crypto_aead_chacha20poly1305_ietf_KEYBYTES,
                                            sodium.from_string(babblePassphrase),
                                            sodium.from_string(babbleSalt),
                                            sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE,
                                            sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE,
                                            sodium.crypto_pwhash_ALG_DEFAULT);
            }
            function encrypt(s) {
                var nonce = sodium.randombytes_buf(sodium.crypto_aead_chacha20poly1305_ietf_NPUBBYTES);
                var cipher = sodium.crypto_aead_chacha20poly1305_ietf_encrypt(sodium.from_string(s), null, null, nonce, babbleKey);
                var ret = new Uint8Array(nonce.length + cipher.length);
                ret.set(nonce);
                ret.set(cipher, nonce.length);
                return ret;
            }
            function decrypt(s) {
                if (s.length < sodium.crypto_aead_chacha20poly1305_ietf_NPUBBYTES + sodium.crypto_aead_chacha20poly1305_ietf_ABYTES)
                    return '';
                var nonce = s.subarray(0, sodium.crypto_aead_chacha20poly1305_ietf_NPUBBYTES);
                var cipher = s.subarray(sodium.crypto_aead_chacha20poly1305_ietf_NPUBBYTES);
                return sodium.to_string(sodium.crypto_aead_chacha20poly1305_ietf_decrypt(null, cipher, null, nonce, babbleKey));
            }
            function hanziEncode(s) {
                var ret = '';
                s.forEach(b => {
                    ret += babbleBase[b];
                });
                return ret;
            }
            function hanziDecode(s) {
                var ret = new Uint8Array(s.length);
                var parsed = 0;
                for (var c of s) {
                    var index = babbleBase.indexOf(c);
                    if (index != -1)
                        ret[parsed++] = index;
                }
                return ret.subarray(0, parsed);
            }
            function babble(s) {
                return hanziEncode(encrypt(s));
            }
            function debabble(s) {
                return decrypt(hanziDecode(s));
            }
            $(window).ready(async() => {
                await sodium.ready;
                loadSettings();
                setSettingsTexts();
                $('#settingsModal').on('shown.bs.modal', () => {
                    $('#passphraseText').trigger('focus');
                });
                $('#settingsModal').on('hidden.bs.modal', setSettingsTexts);
                $('#passphraseText').keypress(settingsEnterPressed);
                $('#baseText').keypress(settingsEnterPressed);
                $('#settingsConfirmButton').click(() => {
                    if ($('#baseText').val().length != 256) {
                        $('#errorModal').modal('show');
                        return;
                    }
                    babblePassphrase = $('#passphraseText').val();
                    babbleBase = $('#baseText').val();
                    babbleKey = deriveKey();
                    saveSettings();
                    $('#settingsModal').modal('hide');
                });
                $('#plainText').keypress((e) => {
                    if ((e.ctrlKey || e.metaKey) && (e.keyCode == 10 || e.keyCode == 13))
                        $('#babbleButton').click();
                });
                $('#cipherText').keypress((e) => {
                    if ((e.ctrlKey || e.metaKey) && (e.keyCode == 10 || e.keyCode == 13))
                        $('#debabbleButton').click();
                });
                $('#babbleButton').click(() => {
                    $('#cipherText').val(babble($('#plainText').val()));
                });
                $('#debabbleButton').click(() => {
                    $('#plainText').val(debabble($('#cipherText').val()));
                });
            });
        </script>
    </body>
</html>
